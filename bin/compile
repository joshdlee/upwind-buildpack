#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
TMP_DIR=$(mktemp -d)

# Variables
client_id="$(cat $ENV_DIR/UPWIND_CLIENT_ID)"
client_secret="$(cat $ENV_DIR/UPWIND_CLIENT_SECRET)"

# Update and install necessary packages
apt-get update
apt-get install curl -y

# Install the Upwind agent with additional environment variables
curl -s https://get.upwind.io/agent-bcc.sh | \
    UPWIND_CLIENT_ID="${client_id}" \
    UPWIND_CLIENT_SECRET="${client_secret}" \
    UPWIND_AGENT_CLOUD_PROVIDER="byoc" \
    UPWIND_AGENT_CLOUD_ACCOUNT_ID="byoc-BYOC" \
    UPWIND_AGENT_ZONE="byoc-us-west" \
    bash -s

# Cleanup temporary directory
rm -rf "$TMP_DIR"

echo "Upwind agent installed successfully."
